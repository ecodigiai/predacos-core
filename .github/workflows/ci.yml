name: Predacos CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test:
    name: ğŸ§ª Testes
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ğŸ“¦ Instalar dependÃªncias
        run: npm ci
      
      - name: ğŸ” Lint
        run: npm run lint || echo "Lint nÃ£o configurado ainda"
      
      - name: ğŸ§ª Executar testes
        run: npm test || echo "Testes nÃ£o configurados ainda"
      
      - name: ğŸ”’ Auditoria de seguranÃ§a
        run: npm audit --audit-level=high || echo "Vulnerabilidades encontradas"

  build:
    name: ğŸ—ï¸ Build
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ğŸ“¦ Instalar dependÃªncias
        run: npm ci
      
      - name: ğŸ—ï¸ Build projeto
        run: npm run build || echo "Build nÃ£o configurado ainda"
      
      - name: ğŸ“¤ Upload artefatos
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            dist/
            build/
          retention-days: 7

  deploy-functions:
    name: ğŸš€ Deploy Firebase Functions
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          npm ci
          cd services/functions && npm ci
      
      - name: ğŸš€ Deploy Firebase Functions
        uses: w9jds/firebase-action@master
        with:
          args: deploy --only functions
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}

  deploy-hosting:
    name: ğŸŒ Deploy Firebase Hosting
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: ğŸ“¦ Instalar dependÃªncias
        run: npm ci
      
      - name: ğŸ—ï¸ Build frontend
        run: npm run build:web || echo "Build web nÃ£o configurado"
      
      - name: ğŸŒ Deploy Firebase Hosting
        uses: w9jds/firebase-action@master
        with:
          args: deploy --only hosting
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}

  notify:
    name: ğŸ“¢ Notificar Status
    runs-on: ubuntu-latest
    needs: [test, build, deploy-functions, deploy-hosting]
    if: always()
    
    steps:
      - name: ğŸ“Š Status do Deploy
        run: |
          echo "âœ… Pipeline concluÃ­do!"
          echo "Status dos jobs:"
          echo "- Testes: ${{ needs.test.result }}"
          echo "- Build: ${{ needs.build.result }}"
          echo "- Deploy Functions: ${{ needs.deploy-functions.result }}"
          echo "- Deploy Hosting: ${{ needs.deploy-hosting.result }}"
